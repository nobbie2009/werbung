<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Signage Player</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        #container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .media-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* or contain */
            opacity: 0;
            transition: opacity 1s ease-in-out;
            z-index: 0;
        }

        .active {
            opacity: 1;
            z-index: 1;
        }

        #loading {
            color: #fff;
            font-size: 2rem;
            z-index: 10;
        }

        #overlay {
            position: absolute;
            bottom: 50px;
            left: 50px;
            z-index: 999;
            /* Very high z-index to ensure visibility */
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            display: none;
            pointer-events: none;
            /* Let clicks pass through */
        }

        #title {
            margin: 0;
            font-size: 3rem;
            font-weight: bold;
        }

        #description {
            margin-top: 10px;
            font-size: 1.5rem;
        }

        #screensaver {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            /* Above everything */
            background: black;
        }
    </style>
</head>

<body>

    <div id="container">
        <div id="loading">Loading content...</div>
    </div>

    <div id="overlay">
        <h1 id="title"></h1>
        <p id="description"></p>
    </div>

    <div id="screensaver"></div>

    <script>
        const container = document.getElementById('container');
        const loading = document.getElementById('loading');
        const screensaverEl = document.getElementById('screensaver');
        const overlay = document.getElementById('overlay');
        const titleEl = document.getElementById('title');
        const descEl = document.getElementById('description');

        let playlist = [];
        let currentIndex = 0;
        let settings = {};
        let idleTimer;

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                settings = await res.json();
                applySettings();
            } catch (e) {
                console.error("Failed to load settings", e);
            }
        }

        function applySettings() {
            document.body.style.backgroundColor = settings.background_color || '#000';

            // Apply custom CSS
            if (settings.custom_css) {
                const existingStyle = document.getElementById('custom-css');
                if (existingStyle) existingStyle.remove();

                const style = document.createElement('style');
                style.id = 'custom-css';
                style.textContent = settings.custom_css;
                document.head.appendChild(style);
            }

            resetIdleTimer();
        }

        function showScreensaver() {
            if (!settings.screensaver_enabled) return;

            screensaverEl.style.display = 'block';
            if (settings.screensaver_type === 'image') {
                screensaverEl.style.background = 'url(https://source.unsplash.com/random/1920x1080) no-repeat center center fixed';
                screensaverEl.style.backgroundSize = 'cover';
            } else {
                screensaverEl.style.background = 'black';
            }
        }

        function hideScreensaver() {
            screensaverEl.style.display = 'none';
        }

        function resetIdleTimer() {
            hideScreensaver();
            if (idleTimer) clearTimeout(idleTimer);
            if (settings.screensaver_enabled && settings.screensaver_timeout) {
                idleTimer = setTimeout(showScreensaver, settings.screensaver_timeout * 1000);
            }
        }

        async function fetchPlaylist() {
            try {
                const response = await fetch('/api/playlist');
                const data = await response.json();
                return data;
            } catch (e) {
                console.error("Failed to fetch playlist", e);
                return [];
            }
        }

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function createMediaElement(item) {
            let el;
            if (item.type === 'video') {
                el = document.createElement('video');
                el.src = item.src;
                el.muted = true;
                el.autoplay = true;
                el.playsInline = true;
                el.classList.add('media-item');
            } else if (item.type === 'image' && item.src) {
                el = document.createElement('img');
                el.src = item.src;
                el.classList.add('media-item');
            } else {
                // Text only (container div)
                el = document.createElement('div');
                el.classList.add('media-item');
            }
            return el;
        }

        async function playLoop() {
            // Reload settings at start of each loop
            if (currentIndex === 0) await loadSettings();

            const newPlaylist = await fetchPlaylist();

            if (newPlaylist.length > 0) {
                playlist = newPlaylist;
                loading.style.display = 'none';
                hideScreensaver();
            }

            if (playlist.length === 0) {
                loading.style.display = 'block';
                loading.innerText = "No active content found.";
                if (settings.screensaver_enabled) showScreensaver();
                await wait(10000);
                playLoop();
                return;
            }

            if (currentIndex >= playlist.length) {
                currentIndex = 0;
            }

            const item = playlist[currentIndex];
            console.log("Playing:", item);

            // Create media element
            const el = createMediaElement(item);
            el.classList.add('active');

            // Clear container and add new element
            container.innerHTML = '';
            container.appendChild(el);

            // Update Overlay
            if (item.title || item.description) {
                titleEl.textContent = item.title || "";
                descEl.textContent = item.description || "";
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }

            // Duration logic
            let duration = (item.duration || 10) * 1000;

            if (item.type === 'video') {
                await new Promise(resolve => {
                    el.onended = resolve;
                    el.onerror = resolve;
                    // Fallback timeout for video
                    setTimeout(resolve, duration + 5000);
                });
            } else {
                await wait(duration);
            }

            currentIndex++;
            playLoop();
        }

        // Initialize
        console.log("App starting...");
        playLoop();

    </script>
</body>

</html>