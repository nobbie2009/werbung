<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Signage Player</title>
    <style>
        :root {
            --bg-color: #000;
            --text-color: #fff;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --footer-height: 12vh;
            /* Slightly taller for readability */
            --content-height: 88vh;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            overflow: hidden;
        }

        /* --- Layout Structure --- */
        #main-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        #content-area {
            flex: 0 0 var(--content-height);
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        #footer {
            flex: 0 0 var(--footer-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(to top, #111, #222);
            padding: 0 2rem;
            padding: 0 2rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 150;
            /* Ensure visibility above content */
        }

        /* --- Footer Components --- */
        .footer-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            height: 100%;
        }

        #footer-left {
            justify-content: flex-start;
            flex: 1;
        }

        #footer-center {
            justify-content: center;
            flex: 1;
        }

        #footer-right {
            justify-content: flex-end;
            flex: 1;
        }

        #company-logo {
            max-height: 70%;
            width: auto;
            border-radius: 4px;
        }

        #contact-info {
            font-size: 1.1rem;
            line-height: 1.4;
        }

        #contact-info span {
            display: block;
        }

        #contact-name {
            font-weight: bold;
            font-size: 1.2rem;
        }

        #qr-container {
            position: fixed;
            bottom: 2vh;
            /* Anchor near bottom */
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            /* Above footer */
            background: white;
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        #qr-container img {
            width: 15vh;
            /* Fixed size larger than footer */
            height: 15vh;
            display: block;
        }

        #clock {
            font-size: 2.5rem;
            font-weight: 200;
            font-variant-numeric: tabular-nums;
            color: #fff;
            /* Enforce white color */
        }

        /* --- Content Layouts --- */
        .media-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            /* Default: Standard centered */
            justify-content: center;
            align-items: center;
        }

        /* Standard Layout (Image/Video Full) */
        .layout-standard img,
        .layout-standard video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* Show full image, black bars if needed. Or cover? User said "when no image ... larger font", implying standard has image. */
            object-fit: cover;
            /* Usually prefer cover for signage */
        }

        /* Text Only Layout */
        .layout-text-only {
            background: var(--bg-color);
            padding: 4rem;
            box-sizing: border-box;
            text-align: center;
            flex-direction: column;
        }

        .layout-text-only h1 {
            font-size: 5vw;
            /* Responsive font sizing */
            margin: 0 0 1rem 0;
            line-height: 1.1;
        }

        .layout-text-only p {
            font-size: 3vw;
            color: #ccc;
        }

        /* Split Layout (Image Left, Text Right) */
        .layout-split {
            flex-direction: row;
        }

        .layout-split .media-side {
            flex: 1;
            height: 100%;
        }

        .layout-split .media-side img,
        .layout-split .media-side video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .layout-split .text-side {
            flex: 1;
            height: 100%;
            padding: 3rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: rgba(20, 20, 20, 0.9);
        }

        .layout-split h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .layout-split p {
            font-size: 1.5rem;
            line-height: 1.6;
        }


        /* --- Overlays & Countdown --- */
        #countdown-overlay {
            /* Defaults defined in JS/Inline or reset here */
            position: fixed;
            /* box-shadow etc */
            background: rgba(185, 28, 28, 0.9);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            text-align: center;
            display: none;
            z-index: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        #countdown-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #countdown-timer {
            font-size: 2rem;
            font-weight: bold;
            font-family: monospace;
            margin-top: 0.2rem;
        }

        /* Screensaver */
        #screensaver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: none;
            background: black;
        }

        /* Standard Overlay Base */
        .overlay {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1.5rem 2rem;
            box-sizing: border-box;
            z-index: 10;
            border-radius: 8px;
            /* Rounded corners for boxes */
        }

        /* Overlay Variants */
        .overlay.pos-bar-bottom {
            bottom: 0;
            left: 0;
            width: 100%;
            border-radius: 0;
        }

        .overlay.pos-bar-top {
            top: 0;
            left: 0;
            width: 100%;
            border-radius: 0;
        }

        .overlay.pos-bottom-left {
            bottom: 2rem;
            left: 2rem;
            max-width: 40%;
        }

        .overlay.pos-bottom-right {
            bottom: 2rem;
            right: 2rem;
            max-width: 40%;
        }

        .overlay.pos-top-left {
            top: 2rem;
            left: 2rem;
            max-width: 40%;
        }

        .overlay.pos-top-right {
            top: 2rem;
            right: 2rem;
            max-width: 40%;
        }

        .overlay h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
        }

        .overlay p {
            margin: 0;
            font-size: 1.2rem;
            line-height: 1.4;
        }

        /* Countdown Positioning (dynamic) */
        #countdown-overlay {
            /* Defaults defined in JS/Inline or reset here */
            position: fixed;
            /* box-shadow etc */
            background: rgba(185, 28, 28, 0.9);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            text-align: center;
            display: none;
            z-index: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        /* Loading */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 1.5rem;
        }
    </style>
</head>

<body>

    <div id="main-wrapper">
        <!-- Main Content (Slide) -->
        <div id="content-area">
            <div id="loading">Loading content...</div>
        </div>

        <!-- Footer -->
        <div id="footer">
            <div id="footer-left" class="footer-section">
                <!-- Injected via JS -->
            </div>

            <div id="footer-center" class="footer-section">
                <!-- QR Code -->
            </div>

            <div id="footer-right" class="footer-section">
                <div id="clock">12:00</div>
            </div>
        </div>
    </div>

    <!-- Floating Elements -->
    <div id="countdown-overlay">
        <div id="countdown-title">Countdown</div>
        <div id="countdown-timer">00d 00h 00m</div>
    </div>

    <div id="screensaver"></div>

    <script>
        const contentArea = document.getElementById('content-area');
        const loading = document.getElementById('loading');
        const footerLeft = document.getElementById('footer-left');
        const footerCenter = document.getElementById('footer-center');
        const clockEl = document.getElementById('clock');
        const screensaverEl = document.getElementById('screensaver');

        const countdownEl = document.getElementById('countdown-overlay');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const countdownTitleEl = document.getElementById('countdown-title');

        let playlist = [];
        let currentIndex = 0;
        let settings = {};
        let idleTimer;
        let countdownInterval;

        // --- Helpers ---
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- Clock ---
        setInterval(() => {
            const now = new Date();
            clockEl.textContent = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }, 1000);

        // --- Settings & Footer ---
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                settings = await res.json();
                applySettings();
            } catch (e) { console.error("Settings load failed", e); }
        }

        function applySettings() {
            // Theme / CSS
            document.documentElement.style.setProperty('--bg-color', settings.background_color || '#000');

            // Font Scale
            const scale = settings.font_scale || 100;
            document.documentElement.style.fontSize = `${16 * (scale / 100)}px`;

            if (settings.custom_css) {
                let style = document.getElementById('custom-css');
                if (!style) {
                    style = document.createElement('style');
                    style.id = 'custom-css';
                    document.head.appendChild(style);
                }
                style.textContent = settings.custom_css;
            }

            // Footer Left: Logo & Contact
            let leftHtml = '';
            // Safe logo injection
            if (settings.logo_url && settings.logo_url.trim() !== '') {
                leftHtml += `<img id="company-logo" src="${settings.logo_url}" onerror="this.style.display='none'">`;
            }
            if (settings.contact_name || settings.contact_phone) {
                leftHtml += `<div id="contact-info" style="color: #fff">
                   <span id="contact-name">${settings.contact_name || ''}</span>
                   <span>${settings.contact_phone || ''}</span>
                </div>`;
            }
            footerLeft.innerHTML = leftHtml;

            // Footer Center: QR Code
            if (settings.contact_homepage) {
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&color=ffffff&bgcolor=000000&margin=0&data=${encodeURIComponent(settings.contact_homepage)}`;
                footerCenter.innerHTML = `<div id="qr-container"><img src="${qrUrl}"></div>`;
            } else {
                footerCenter.innerHTML = '';
            }

            // Countdown
            if (settings.countdown_enabled && settings.countdown_target) {
                startCountdown(settings.countdown_target, settings.countdown_title);
            } else {
                countdownEl.style.display = 'none';
            }

            resetIdleTimer();
        }

        // --- Countdown Logic ---
        function startCountdown(targetDateIso, title) {
            if (countdownInterval) clearInterval(countdownInterval);

            const target = new Date(targetDateIso).getTime();
            countdownTitleEl.textContent = title || "Event starts in";
            countdownEl.style.display = 'block';

            const update = () => {
                const now = new Date().getTime();
                const diff = target - now;

                if (diff <= 0) {
                    // Timer expired
                    countdownEl.style.display = 'none';
                    if (countdownInterval) clearInterval(countdownInterval);
                } else {
                    countdownEl.style.display = 'flex'; // Ensure visible
                    document.getElementById('countdown-title').textContent = title || "Countdown"; // Changed to use countdown-title

                    // Format Target Date
                    const targetDate = new Date(target);
                    const dateOpts = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                    const dateStr = targetDate.toLocaleDateString('de-DE', dateOpts);
                    let dateEl = document.getElementById('cd-date');
                    if (!dateEl) {
                        dateEl = document.createElement('div');
                        dateEl.id = 'cd-date';
                        dateEl.style.fontSize = '2vw';
                        dateEl.style.marginTop = '1vw';
                        dateEl.style.opacity = '0.8';
                        countdownEl.appendChild(dateEl);
                    }
                    dateEl.textContent = dateStr;

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    // Assuming countdown-timer div contains elements with these IDs
                    // If not, these elements need to be created or the HTML adjusted.
                    // For now, we'll update the existing countdownTimerEl with a new structure.
                    countdownTimerEl.innerHTML = `
                        <span id="cd-days">${days}</span>d 
                        <span id="cd-hours">${hours.toString().padStart(2, '0')}</span>h 
                        <span id="cd-minutes">${minutes.toString().padStart(2, '0')}</span>m 
                        <span id="cd-seconds">${seconds.toString().padStart(2, '0')}</span>s
                    `;
                }
            };

            update();
            countdownInterval = setInterval(update, 1000); // Changed to 1 second for seconds update
        }

        // --- Screensaver ---
        function showScreensaver() {
            if (!settings.screensaver_enabled) return;
            screensaverEl.style.display = 'block';
            if (settings.screensaver_type === 'image') {
                screensaverEl.style.background = 'url(https://source.unsplash.com/random/1920x1080) no-repeat center center fixed';
                screensaverEl.style.backgroundSize = 'cover';
            } else {
                screensaverEl.style.background = 'black';
            }
        }
        function hideScreensaver() { screensaverEl.style.display = 'none'; }
        function resetIdleTimer() {
            hideScreensaver();
            if (idleTimer) clearTimeout(idleTimer);
            if (settings.screensaver_enabled && settings.screensaver_timeout) {
                idleTimer = setTimeout(showScreensaver, settings.screensaver_timeout * 1000);
            }
        }

        // --- Playlist & Playback ---
        async function fetchPlaylist() {
            try {
                const res = await fetch('/api/playlist');
                return await res.json();
            } catch (e) {
                return [];
            }
        }

        function createSlideElement(item, overlayClass) {
            const container = document.createElement('div');
            container.classList.add('media-container');

            // Determine Layout
            let layout = item.layout || 'Standard';
            // Force text-only layout if no media src
            if (item.type === 'text' || !item.src) {
                layout = 'Text Only';
            }

            if (layout === 'Text Only') {
                container.classList.add('layout-text-only');
                const h1 = document.createElement('h1');
                h1.textContent = item.title;
                const p = document.createElement('p');
                p.textContent = item.description;
                container.appendChild(h1);
                container.appendChild(p);

            } else if (layout === 'Split') {
                container.classList.add('layout-split');

                // Media Side
                const mediaDiv = document.createElement('div');
                mediaDiv.classList.add('media-side');
                const mediaEl = (item.type === 'video') ? document.createElement('video') : document.createElement('img');
                mediaEl.src = item.src;
                if (item.type === 'video') { mediaEl.muted = true; mediaEl.autoplay = true; mediaEl.playsInline = true; }
                mediaDiv.appendChild(mediaEl);

                // Text Side
                const textDiv = document.createElement('div');
                textDiv.classList.add('text-side');
                textDiv.innerHTML = `<h1>${item.title}</h1><p>${item.description}</p>`;

                container.appendChild(mediaDiv);
                container.appendChild(textDiv);

                return { element: container, media: mediaEl }; // Return media el for waiting logic

            } else {
                // Standard (Fullscreen Media)
                container.classList.add('layout-standard');
                const mediaEl = (item.type === 'video') ? document.createElement('video') : document.createElement('img');
                mediaEl.src = item.src;
                if (item.type === 'video') { mediaEl.muted = true; mediaEl.autoplay = true; mediaEl.playsInline = true; }
                container.appendChild(mediaEl);

                // Optional: Overlay for Standard (if text exists)
                if (item.title || item.description) {
                    const overlay = document.createElement('div');
                    overlay.classList.add('overlay');
                    if (overlayClass) overlay.classList.add(overlayClass);

                    let html = '';
                    if (item.title) html += `<h1>${item.title}</h1>`;
                    if (item.description) html += `<p>${item.description}</p>`;
                    overlay.innerHTML = html;
                    container.appendChild(overlay);
                }
                return { element: container, media: mediaEl };
            }
            return { element: container, media: null };
        }

        async function playLoop() {
            if (currentIndex === 0) await loadSettings(); // Refresh settings each loop

            const newPlaylist = await fetchPlaylist();
            if (newPlaylist.length > 0) {
                playlist = newPlaylist;
                loading.style.display = 'none';
                hideScreensaver();
            }

            if (playlist.length === 0) {
                loading.style.display = 'block';
                loading.innerText = "No content available.";
                if (settings.screensaver_enabled) showScreensaver();
                await wait(10000);
                playLoop();
                return;
            }

            if (currentIndex >= playlist.length) currentIndex = 0;
            const item = playlist[currentIndex];

            // Randomize Positions
            // Available: 'top', 'bottom'. (Simplification to avoid overlapping complex floaters)
            // Or full set: bar-bottom, bar-top, bottom-left, bottom-right, top-left, top-right.

            const overlayPositions = ['pos-bar-bottom', 'pos-bar-top', 'pos-bottom-left', 'pos-bottom-right', 'pos-top-left', 'pos-top-right'];
            const contentPos = overlayPositions[Math.floor(Math.random() * overlayPositions.length)];

            // Determine compatible Countdown Position
            // If content is top*, countdown must be bottom*.
            // If content is bottom*, countdown must be top*.
            let countdownPosSpecs = [];

            if (contentPos.includes('top')) {
                countdownPosSpecs = [
                    { top: 'auto', bottom: '14vh', left: '2rem', right: 'auto' }, // Bottom Left (above footer)
                    { top: 'auto', bottom: '14vh', left: 'auto', right: '2rem' }  // Bottom Right
                ];
            } else {
                countdownPosSpecs = [
                    { top: '2rem', bottom: 'auto', left: '2rem', right: 'auto' }, // Top Left
                    { top: '2rem', bottom: 'auto', left: 'auto', right: '2rem' }  // Top Right
                ];
            }
            const cdPos = countdownPosSpecs[Math.floor(Math.random() * countdownPosSpecs.length)];

            // Apply Countdown Pos
            countdownEl.style.top = cdPos.top;
            countdownEl.style.bottom = cdPos.bottom;
            countdownEl.style.left = cdPos.left;
            countdownEl.style.right = cdPos.right;

            const { element, media } = createSlideElement(item, contentPos);

            // Cross-Fade Logic
            element.style.opacity = 0;
            element.style.transition = 'opacity 1s ease-in-out';
            contentArea.appendChild(element);

            // Trigger Fade In
            requestAnimationFrame(() => {
                element.style.opacity = 1;
            });

            // Fade Out Old
            const oldElements = Array.from(contentArea.children).filter(el => el !== element && el.id !== 'loading');
            oldElements.forEach(old => {
                old.style.transition = 'opacity 1s ease-in-out';
                old.style.opacity = 0;
                setTimeout(() => {
                    if (old.parentNode) old.parentNode.removeChild(old);
                }, 1000);
            });

            // Wait for duration
            let duration = (item.duration || 10) * 1000;

            if (item.type === 'video' && media) {
                await new Promise(resolve => {
                    media.onended = resolve;
                    media.onerror = resolve;
                    // Safety timeout
                    setTimeout(resolve, duration + 10000);
                });
            } else {
                await wait(duration);
            }

            currentIndex++;
            playLoop();
        }

        // --- Auto-Refresh (Version & Token Check) ---
        let currentVersion = null;
        let currentRefreshToken = null;

        async function checkVersion() {
            try {
                const res = await fetch('/api/system/version');
                const data = await res.json();

                // 1. Check Server Version (Firmware Update / Restart)
                if (currentVersion === null) {
                    currentVersion = data.version;
                } else if (currentVersion !== data.version) {
                    console.log("New system version detected. Reloading...");
                    window.location.reload();
                    return;
                }

                // 2. Check Refresh Token (Manual Trigger)
                if (currentRefreshToken === null) {
                    currentRefreshToken = data.refresh_token;
                } else if (data.refresh_token && currentRefreshToken !== data.refresh_token) {
                    console.log("Refresh command received. Reloading...");
                    window.location.reload(true); // Force reload
                }

            } catch (e) { console.error("Version check failed", e); }
        }
        setInterval(checkVersion, 30000); // Check every 30s

        // --- Service Worker (Caching) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js').then(reg => {
                    console.log('SW registered:', reg);
                }).catch(err => console.log('SW registration failed:', err));
            });
        }

        // --- Init ---
        playLoop();
        checkVersion(); // Initial check

    </script>
</body>

</html>