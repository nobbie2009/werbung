<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Signage Player</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }

        #container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .media-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* or contain */
            opacity: 0;
            transition: opacity 1s ease-in-out;
            z-index: 0;
        }

        .active {
            opacity: 1;
            z-index: 1;
        }

        #loading {
            color: #fff;
            font-family: sans-serif;
            font-size: 2rem;
            z-index: 10;
        }
    </style>
</head>

<body>

    <div id="container">
        <div id="loading">Loading content...</div>
        <!-- Media elements will be injected here or managed here -->
    </div>

    <script>
        const container = document.getElementById('container');
        const loading = document.getElementById('loading');
        let playlist = [];
        let currentIndex = 0;

        async function fetchPlaylist() {
            try {
                const response = await fetch('/api/playlist');
                const data = await response.json();
                return data;
            } catch (e) {
                console.error("Failed to fetch playlist", e);
                return [];
            }
        }

        // Wait helper
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function createMediaElement(item) {
            let el;
            if (item.type === 'video') {
                el = document.createElement('video');
                el.src = item.src;
                el.muted = true; // Required for autoplay usually
                el.autoplay = true;
                el.playsInline = true;
                el.classList.add('media-item');
            } else {
                el = document.createElement('img');
                el.src = item.src;
                el.classList.add('media-item');
            }
            return el;
        }

        async function playLoop() {
            // Refresh playlist at start of loop
            const newPlaylist = await fetchPlaylist();

            if (newPlaylist.length > 0) {
                playlist = newPlaylist;
                loading.style.display = 'none';
            }

            if (playlist.length === 0) {
                loading.style.display = 'block';
                loading.innerText = "No active content found. Retrying in 10s...";
                await wait(10000);
                playLoop(); // Recursion but with delay is fine
                return;
            }

            // Logic to cycle
            // If index out of bounds, reset
            if (currentIndex >= playlist.length) {
                currentIndex = 0;
                // Optionally reload page to clear memory leaks?
                // window.location.reload(); 
            }

            const item = playlist[currentIndex];
            const nextIndex = (currentIndex + 1) % playlist.length;

            // Improve transition: Preload next item? 
            // For MVP, just swap.

            const el = createMediaElement(item);
            el.classList.add('active'); // Start visible? Or fade in?
            container.innerHTML = ''; // Clear previous
            container.appendChild(el);

            // Calculate Duration
            let duration = (item.duration || 10) * 1000;

            if (item.type === 'video') {
                // Wait for video end
                await new Promise(resolve => {
                    el.onended = resolve;
                    el.onerror = resolve; // Skip if error
                    // Fallback timeout just in case
                    // setTimeout(resolve, 60000); 
                });
            } else {
                await wait(duration);
            }

            currentIndex++;
            playLoop();
        }

        // Start
        playLoop();

    </script>
</body>

</html>