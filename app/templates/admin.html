<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Signage Admin</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 2rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #1f2937;
        }

        .tab-btn.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }

        /* Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .help-text {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        input[type="text"],
        input[type="number"],
        input[type="datetime-local"],
        select,
        textarea,
        input[type="color"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #fff;
        }

        input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
            margin-right: 0.5rem;
        }

        button.action-btn {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
        }

        button.action-btn:hover {
            background-color: #1d4ed8;
        }

        #message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .error {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body>
    <h1>Digital Signage Verwaltung</h1>

    <!-- Tabs Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'tab-general')">Allgemein</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-design')">Design</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-countdown')">Countdown</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-screensaver')">Bildschirmschoner</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-maintenance')">Wartung</button>
    </div>

    <!-- MAIN FORM -->
    <form id="settingsForm">

        <!-- Tab: Allgemein -->
        <div id="tab-general" class="tab-content active card">
            <h2>Allgemeine Einstellungen</h2>
            <div class="form-group">
                <label for="theme">Design-Modus</label>
                <select id="theme" name="theme">
                    <option value="dark">Dunkel (Dark Mode)</option>
                    <option value="light">Hell (Light Mode)</option>
                </select>
                <div class="help-text">Bestimmt die grundlegende Farbgebung des Players.</div>
            </div>
            <div class="form-group">
                <label for="background_color">Hintergrundfarbe</label>
                <input type="color" id="background_color" name="background_color" value="#000000">
                <div class="help-text">Hintergrundfarbe, falls Inhalte nicht den ganzen Screen füllen.</div>
            </div>
            <div class="form-group">
                <label for="font_scale">Schriftgröße skalieren (%)</label>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <input type="range" id="font_scale" name="font_scale" min="50" max="200" value="100"
                        style="flex: 1;"
                        oninput="document.getElementById('font_scale_val').textContent = this.value + '%'">
                    <span id="font_scale_val" style="font-weight: bold; width: 3rem; text-align: right;">100%</span>
                </div>
                <div class="help-text">Passt die Größe von Titeln und Texten global an.</div>
            </div>
        </div>

        <!-- Tab: Design (CI) -->
        <div id="tab-design" class="tab-content card">
            <h2>Erscheinungsbild (Corporate Identity)</h2>
            <p class="help-text" style="margin-bottom: 1rem;">Passen Sie den Footer an Ihre Marke an.</p>

            <div class="form-group">
                <label for="logo_url">Logo-URL</label>
                <input type="text" id="logo_url" name="logo_url" placeholder="https://example.com/logo.png">
                <div class="help-text">Direkter Link zum Logo (JPG/PNG).</div>
            </div>
            <div class="form-group">
                <label for="contact_name">Firmenname</label>
                <input type="text" id="contact_name" name="contact_name" placeholder="Musterfirma GmbH">
            </div>
            <div class="form-group">
                <label for="contact_phone">Telefonnummer</label>
                <input type="text" id="contact_phone" name="contact_phone" placeholder="+49 123 456789">
            </div>
            <div class="form-group">
                <label for="contact_homepage">Webseite-URL</label>
                <input type="text" id="contact_homepage" name="contact_homepage"
                    placeholder="https://www.meine-firma.de">
                <div class="help-text">Daraus wird automatisch ein QR-Code generiert.</div>
            </div>
            <div class="form-group">
                <label for="custom_css">Eigenes CSS (Experten)</label>
                <textarea id="custom_css" name="custom_css" rows="5" placeholder="body { ... }"></textarea>
            </div>
        </div>

        <!-- Tab: Countdown -->
        <div id="tab-countdown" class="tab-content card">
            <h2>Countdown (Ereignis-Timer)</h2>
            <div class="form-group">
                <label for="countdown_enabled">Countdown aktivieren?</label>
                <select id="countdown_enabled" name="countdown_enabled">
                    <option value="false">Nein</option>
                    <option value="true">Ja</option>
                </select>
            </div>

            <div class="form-group">
                <label for="countdown_mode">Quelle</label>
                <select id="countdown_mode" name="countdown_mode">
                    <option value="manual">Manuell eingeben</option>
                    <option value="calendar">Google Kalender (iCal)</option>
                </select>
            </div>

            <!-- Manual Settings -->
            <div id="countdown_manual_settings">
                <div class="form-group">
                    <label for="countdown_title">Titel des Ereignisses</label>
                    <input type="text" id="countdown_title" name="countdown_title" placeholder="Event beginnt in">
                    <div class="help-text">Wird über dem Timer angezeigt.</div>
                </div>
                <div class="form-group">
                    <label for="countdown_target">Zielzeitpunkt</label>
                    <input type="datetime-local" id="countdown_target" name="countdown_target">
                    <div class="help-text">Datum und Uhrzeit des Ziels.</div>
                </div>
            </div>

            <!-- Calendar Settings -->
            <div id="countdown_calendar_settings" style="display: none;">
                <div class="form-group">
                    <label for="calendar_url">iCal Adresse (Google Kalender)</label>
                    <input type="text" id="calendar_url" name="calendar_url"
                        placeholder="https://calendar.google.com/calendar/ical/.../basic.ics">
                    <div class="help-text">Die <strong>GEHEIMADRESSE</strong> im iCal-Format aus den Google Kalender
                        Einstellungen.</div>
                </div>
                <div class="form-group">
                    <label for="calendar_filter">Filter-Stichwort (Optional)</label>
                    <input type="text" id="calendar_filter" name="calendar_filter" placeholder="z.B. Eröffnung">
                    <div class="help-text">Nur Events zählen, die dieses Wort im Titel haben.</div>
                </div>
            </div>

            <!-- Display Options -->
            <div class="form-group" style="background: #f9fafb; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                <label style="margin-bottom: 0.5rem;">Anzeige-Optionen:</label>
                <div style="display: flex; gap: 2rem;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="countdown_show_timer" name="countdown_show_timer" value="true"
                            checked>
                        <label for="countdown_show_timer" style="display: inline; font-weight: normal; margin:0;">Timer
                            (Tage/Std/Min)</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="countdown_show_date" name="countdown_show_date" value="true" checked>
                        <label for="countdown_show_date"
                            style="display: inline; font-weight: normal; margin:0;">Absolute Zielzeit</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Screensaver -->
        <div id="tab-screensaver" class="tab-content card">
            <h2>Bildschirmschoner</h2>
            <div class="form-group">
                <label for="screensaver_enabled">Bildschirmschoner aktiv?</label>
                <select id="screensaver_enabled" name="screensaver_enabled">
                    <option value="true">Ja</option>
                    <option value="false">Nein</option>
                </select>
            </div>
            <div class="form-group">
                <label for="screensaver_timeout">Wartezeit (Sekunden)</label>
                <input type="number" id="screensaver_timeout" name="screensaver_timeout" min="10">
            </div>
            <div class="form-group">
                <label for="screensaver_type">Art des Schoners</label>
                <select id="screensaver_type" name="screensaver_type">
                    <option value="black">Schwarzer Bildschirm</option>
                    <option value="image">Zufallsbild (Unsplash)</option>
                </select>
            </div>
        </div>

        <!-- SAVE BUTTON (Bottom Sticky or just bottom) -->
        <div
            style="margin-top: 2rem; background: white; padding: 1rem; border-top: 1px solid #e5e7eb; position: sticky; bottom: 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
            <button type="submit" class="action-btn" style="width: 100%;">Einstellungen speichern</button>
            <div id="message"></div>
        </div>

    </form>

    <!-- Tab: Wartung (Kein Formular, separate Actions) -->
    <div id="tab-maintenance" class="tab-content card" style="margin-top: 2rem;">
        <h2>Wartung & Aktionen</h2>
        <p class="help-text" style="margin-bottom: 1rem;">Systemsteuerung und Updates.</p>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button type="button" id="btnUpdate" class="action-btn" style="background-color: #059669;">Notion
                Sync</button>
            <button type="button" id="btnRefresh" class="action-btn" style="background-color: #3b82f6;">Browser neu
                laden</button>
            <button type="button" id="btnSystemUpdate" class="action-btn" style="background-color: #db2777;">System
                Update</button>
            <button type="button" id="btnBackup" class="action-btn" style="background-color: #4b5563;">Backup
                downloaden</button>
        </div>

        <div id="maintMessage" style="margin-top: 1rem; padding: 1rem; display: none; border-radius: 4px;"></div>
        <div style="margin-top: 1rem; font-size: 0.8rem; color: #9ca3af; text-align: right;">
            Version: <span id="systemVersion">Lade...</span>
        </div>
    </div>

    <script>
        // Tab Handling
        function openTab(evt, tabName) {
            var i, tabContent, tabBtn;

            tabContent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabContent.length; i++) {
                tabContent[i].style.display = "none";
                tabContent[i].classList.remove("active");
            }

            tabBtn = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tabBtn.length; i++) {
                tabBtn[i].className = tabBtn[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            // Check if tabular was inside form or outside (maintenance is outside)
            // Actually I put maintenance outside the form, so distinct block.
            // But if I want tabs to switch between form sections AND maintenance...
            // the logic above just hides/shows IDs. It works fine.

            evt.currentTarget.className += " active";
        }

        const form = document.getElementById('settingsForm');
        const messageDiv = document.getElementById('message');
        const maintMessage = document.getElementById('maintMessage');

        // Countdown Source logic
        const modeSelect = document.getElementById('countdown_mode');
        const manualDiv = document.getElementById('countdown_manual_settings');
        const calendarDiv = document.getElementById('countdown_calendar_settings');

        function updateVisibility() {
            if (modeSelect.value === 'calendar') {
                manualDiv.style.display = 'none';
                calendarDiv.style.display = 'block';
            } else {
                manualDiv.style.display = 'block';
                calendarDiv.style.display = 'none';
            }
        }
        modeSelect.addEventListener('change', updateVisibility);

        // Load Settings
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                const setVal = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.value = val !== undefined ? val : "";
                };

                // General
                setVal('theme', data.theme);
                setVal('background_color', data.background_color);
                setVal('font_scale', data.font_scale || 100);
                document.getElementById('font_scale_val').textContent = (data.font_scale || 100) + '%';

                // Design
                setVal('logo_url', data.logo_url);
                setVal('contact_name', data.contact_name);
                setVal('contact_phone', data.contact_phone);
                setVal('contact_homepage', data.contact_homepage);
                setVal('custom_css', data.custom_css);

                // Countdown
                setVal('countdown_enabled', data.countdown_enabled.toString());
                setVal('countdown_mode', data.countdown_mode || "manual");
                setVal('countdown_title', data.countdown_title);
                setVal('countdown_target', data.countdown_target);
                setVal('calendar_url', data.calendar_url);
                setVal('calendar_filter', data.calendar_filter);

                if (document.getElementById('countdown_show_timer')) {
                    document.getElementById('countdown_show_timer').checked = data.countdown_show_timer !== false;
                    document.getElementById('countdown_show_date').checked = data.countdown_show_date !== false;
                }

                // Screensaver
                setVal('screensaver_enabled', data.screensaver_enabled.toString());
                setVal('screensaver_timeout', data.screensaver_timeout);
                setVal('screensaver_type', data.screensaver_type);

                updateVisibility();
            } catch (err) { console.error(err); }
        }
        loadSettings();

        // Load Version
        async function loadVersion() {
            try {
                const res = await fetch('/api/system/version');
                const data = await res.json();
                document.getElementById('systemVersion').textContent = data.commit || 'Unbekannt';
            } catch (e) { document.getElementById('systemVersion').textContent = 'Fehler'; }
        }
        loadVersion();

        // Save Settings
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const jsonData = {};

            // Handle Checkboxes
            jsonData.countdown_show_timer = document.getElementById('countdown_show_timer').checked;
            jsonData.countdown_show_date = document.getElementById('countdown_show_date').checked;

            formData.forEach((value, key) => {
                if (['screensaver_enabled', 'countdown_enabled'].includes(key)) {
                    jsonData[key] = value === 'true';
                } else if (['screensaver_timeout', 'font_scale'].includes(key)) {
                    jsonData[key] = parseInt(value);
                } else if (!['countdown_show_timer', 'countdown_show_date'].includes(key)) {
                    jsonData[key] = value;
                }
            });

            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });
                if (res.ok) {
                    messageDiv.className = 'success';
                    messageDiv.textContent = 'Gespeichert!';
                    messageDiv.style.display = 'block';
                    setTimeout(() => messageDiv.style.display = 'none', 3000);
                } else throw new Error();
            } catch (err) {
                messageDiv.className = 'error';
                messageDiv.textContent = 'Fehler beim Speichern.';
                messageDiv.style.display = 'block';
            }
        });

        // Maintenance Actions
        async function triggerAction(endpoint, btnId, msgLoading, msgSuccess) {
            const btn = document.getElementById(btnId);
            const msg = document.getElementById('maintMessage');
            msg.style.display = 'block';
            msg.style.background = '#e5e7eb';
            msg.textContent = msgLoading;

            try {
                const res = await fetch(endpoint, { method: 'POST' });
                if (res.ok) {
                    msg.style.background = '#d1fae5';
                    msg.textContent = msgSuccess;
                } else throw new Error();
            } catch (e) {
                msg.style.background = '#fee2e2';
                msg.textContent = 'Fehler aufgetreten.';
            }
            setTimeout(() => msg.style.display = 'none', 5000);
        }

        document.getElementById('btnUpdate').onclick = () => triggerAction('/api/trigger_sync', 'btnUpdate', 'Sync läuft...', 'Sync erfolgreich!');
        document.getElementById('btnRefresh').onclick = () => triggerAction('/api/system/refresh', 'btnRefresh', 'Sende Reload...', 'Browser laden neu.');
        document.getElementById('btnSystemUpdate').onclick = async () => {
            if (confirm("Update wirklich starten?")) {
                triggerAction('/api/system/update', 'btnSystemUpdate', 'Update läuft...', 'Update fertig (System startet neu).');
            }
        };
        document.getElementById('btnBackup').onclick = () => window.location.href = '/api/backup';

    </script>
</body>

</html>